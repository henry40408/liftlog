{% extends "base.html" %}

{% block title %}Workout {{ workout.date }} - LiftLog{% endblock %}

{% block content %}
{% include "nav.html" %}

<h1>Workout: {{ workout.date }}</h1>

{% match workout.notes %}
{% when Some with (notes) %}
<p class="muted"><em>{{ notes }}</em></p>
{% when None %}
{% endmatch %}

<div class="actions">
    <a href="/workouts/{{ workout.id }}/edit">[Edit]</a>
    <form action="/workouts/{{ workout.id }}/delete" method="post" style="display:inline;"
          onsubmit="return confirm('Delete this workout?');">
        <button type="submit" class="btn-small btn-inline">[Delete]</button>
    </form>
</div>

<h3>Add Set</h3>
<form method="post" action="/workouts/{{ workout.id }}/logs">
    <div class="form-group">
        <label for="exercise_id">Exercise</label>
        <select id="exercise_id" name="exercise_id" required>
            <option value="">-- Select --</option>
            {% for ex in exercises %}
            <option value="{{ ex.id }}">{{ ex.name }} ({{ ex.category }})</option>
            {% endfor %}
        </select>
        <div id="exercise-pr-info" class="pr-info"></div>
    </div>
    <div class="form-group">
        <label for="weight">Weight</label>
        <input type="number" id="weight" name="weight" step="0.5" min="0" required>
    </div>
    <div class="form-group">
        <label for="reps">Reps</label>
        <input type="number" id="reps" name="reps" min="1" required>
    </div>
    <div class="form-group">
        <label for="rpe">RPE (1-10, optional)</label>
        <input type="number" id="rpe" name="rpe" min="1" max="10">
    </div>
    <button type="submit">[Add Set]</button>
</form>

<h2>Sets</h2>

{% if let Some(err) = error %}
<div class="error">{{ err }}</div>
{% endif %}

{% if logs.is_empty() %}
<p class="muted">No sets recorded yet.</p>
{% else %}
<div class="sets-list">
    <div class="sets-header">
        <div>Exercise</div>
        <div>Set</div>
        <div>Weight</div>
        <div>Reps</div>
        <div>RPE</div>
        <div></div>
    </div>
    {% for log in logs %}
    <div class="set-row">
        <div class="set-cell set-cell-exercise"><a href="/stats/exercise/{{ log.exercise_id }}">{{ log.exercise_name }}</a></div>
        <div class="set-cell set-cell-set">{{ log.set_number }}</div>
        <div class="set-cell set-cell-weight">{{ log.weight }}</div>
        <div class="set-cell set-cell-reps">{{ log.reps }}</div>
        <div class="set-cell set-cell-rpe">{% match log.rpe %}{% when Some with (r) %}{{ r }}{% when None %}-{% endmatch %}</div>
        <div class="set-cell set-cell-pr">{% if log.is_pr %}<span class="pr-badge">PR</span>{% endif %}</div>
        <div class="set-row-actions">
            <a href="/workouts/{{ workout.id }}/logs/{{ log.id }}/edit" class="btn-small btn-inline">[Edit]</a>
            <button type="button" class="btn-small btn-inline" onclick="cloneSet('{{ log.exercise_id }}', {{ log.weight }}, {{ log.reps }}, {% match log.rpe %}{% when Some with (r) %}{{ r }}{% when None %}null{% endmatch %})">[Clone]</button>
            <form action="/workouts/{{ workout.id }}/logs/{{ log.id }}/delete" method="post" style="display:inline;"
                  onsubmit="return confirm('Delete this set?');">
                <button type="submit" class="btn-small btn-inline">[x]</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="link">
    &larr; <a href="/workouts">[Back to Workouts]</a>
</div>

<script>
var exercisePRs = {};
{% for pr in exercise_prs %}
exercisePRs["{{ pr.exercise_id }}"] = {
    weight: {{ pr.value }},
    date: "{{ pr.achieved_at.format("%Y-%m-%d") }}"
};
{% endfor %}

var prInfoEl = document.getElementById('exercise-pr-info');
var exerciseSelect = document.getElementById('exercise_id');

function showPRInfo(exerciseId) {
    if (exerciseId && exercisePRs[exerciseId]) {
        var pr = exercisePRs[exerciseId];
        prInfoEl.innerHTML = "歷史最重: " + pr.weight + " kg @ " + pr.date +
            ' <button type="button" class="btn-small btn-inline" onclick="fillMaxWeight()">[填入]</button>';
        prInfoEl.classList.add('visible');
    } else {
        prInfoEl.innerHTML = "";
        prInfoEl.classList.remove('visible');
    }
}

function fillMaxWeight() {
    var exerciseId = exerciseSelect.value;
    if (exerciseId && exercisePRs[exerciseId]) {
        document.getElementById('weight').value = exercisePRs[exerciseId].weight;
    }
}

exerciseSelect.addEventListener('change', function() {
    showPRInfo(this.value);
});

function cloneSet(exerciseId, weight, reps, rpe) {
    exerciseSelect.value = exerciseId;
    document.getElementById('weight').value = weight;
    document.getElementById('reps').value = reps;
    if (rpe !== null) {
        document.getElementById('rpe').value = rpe;
    } else {
        document.getElementById('rpe').value = '';
    }
    showPRInfo(exerciseId);
    exerciseSelect.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
